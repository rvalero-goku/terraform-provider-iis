# IIS API Token Resource

The `iis_api_token` resource dynamically generates IIS Administration API access tokens using NTLM authentication. This eliminates the need for manually creating and managing API tokens.

## Example Usage

### Basic Token Generation

```hcl
resource "iis_api_token" "server" {
  host          = "https://iis-server.example.com:55539"
  ntlm_username = "administrator"
  ntlm_password = var.admin_password
  insecure      = true
}

# Use the generated token
provider "iis" {
  host       = "https://iis-server.example.com:55539"
  access_key = iis_api_token.server.access_token
  insecure   = true
}
```

### With Domain Authentication

```hcl
resource "iis_api_token" "domain_server" {
  host          = "https://iis-server.example.com:55539"
  ntlm_username = "admin"
  ntlm_password = var.admin_password
  ntlm_domain   = "MYDOMAIN"
  insecure      = false
}
```

### Multi-Server Deployment

```hcl
locals {
  servers = {
    server1 = "https://iis-server1.example.com:55539"
    server2 = "https://iis-server2.example.com:55539"
  }
}

# Generate tokens for all servers
resource "iis_api_token" "servers" {
  for_each = local.servers

  host          = each.value
  ntlm_username = var.ntlm_username
  ntlm_password = var.ntlm_password
  insecure      = true
}

# Configure providers with generated tokens
provider "iis" {
  for_each = local.servers
  alias    = each.key

  host       = each.value
  access_key = iis_api_token.servers[each.key].access_token
  insecure   = true
}
```

## Argument Reference

The following arguments are supported:

* `host` - (Required) The IIS Administration API host URL (e.g., `https://server:55539`). Forces new resource.

* `ntlm_username` - (Required, Sensitive) Username for NTLM authentication. Forces new resource.

* `ntlm_password` - (Required, Sensitive) Password for NTLM authentication. Forces new resource.

* `ntlm_domain` - (Optional) Domain for NTLM authentication. Leave empty for local accounts. Default: `""`. Forces new resource.

* `insecure` - (Optional) Skip TLS certificate verification. Useful for self-signed certificates. Default: `false`. Forces new resource.

* `expires_on` - (Optional) Token expiration date. Empty string means the token never expires. Default: `""`. Forces new resource.

## Attribute Reference

In addition to all arguments above, the following attributes are exported:

* `access_token` - (Sensitive) The generated API access token. This value is marked as sensitive and won't be displayed in logs or console output.

## Implementation Details

The token generation process follows the Microsoft IIS.Administration API specification:

1. Sends a GET request to `/security/api-keys` with NTLM credentials to retrieve an XSRF token
2. Sends a POST request to `/security/api-keys` with the XSRF token to create a new API key
3. Validates the returned token (must be 54 characters long for IIS Admin API)
4. Stores the token securely in Terraform state

### Token Lifecycle

* **Create**: Generates a new API token using NTLM authentication
* **Read**: No-op (token validity is not checked to avoid unnecessary API calls)
* **Update**: Not supported - any changes to inputs force resource recreation
* **Delete**: Removes token from Terraform state (optional: could be extended to revoke token via API)

## Security Considerations

1. **Sensitive Values**: Both input credentials and output tokens are marked as sensitive
2. **State Security**: Tokens are stored in Terraform state - use remote state with encryption
3. **Token Rotation**: Destroy and recreate the resource to generate new tokens
4. **TLS**: Set `insecure = false` in production environments with valid certificates

## Notes

* Tokens generated by this resource never expire by default
* The resource uses the same HTTP client configuration as the provider (TLS settings, etc.)
* Each server requires its own token resource instance
* Tokens are tied to the server they were created on and cannot be used across servers

## Troubleshooting

### Token Generation Fails

If token generation fails, check:

1. NTLM credentials are correct
2. User has permission to access IIS Administration API
3. IIS Administration API is running on the target server
4. Network connectivity to the server (firewall, DNS, etc.)
5. TLS settings (`insecure = true` for self-signed certificates)

### Invalid Token Length

If you receive an error about invalid token length:

* IIS Admin API tokens should be 54 characters long
* Verify the API is responding correctly
* Check API logs on the IIS server
